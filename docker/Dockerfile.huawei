# 华为昇腾 Docker镜像 - 视觉大模型教程
# 基于CANN 7.0 + PyTorch (Ascend版本)
# 适用于：昇腾NPU的模型训练和推理

FROM ascendhub.huawei.com/public-ascendhub/ascend-pytorch:23.0.RC3-ubuntu18.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=UTF-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# CANN环境变量（已在基础镜像中设置，这里显式声明）
ENV ASCEND_HOME=/usr/local/Ascend \
    LD_LIBRARY_PATH=/usr/local/Ascend/driver/lib64:/usr/local/Ascend/add-ons:$LD_LIBRARY_PATH \
    PATH=/usr/local/Ascend/latest/bin:$PATH \
    PYTHONPATH=/usr/local/Ascend/latest/python/site-packages:$PYTHONPATH

# 设置工作目录
WORKDIR /workspace

# 更新软件源（可选，用于加速下载）
# RUN sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 开发工具
    build-essential \
    cmake \
    git \
    wget \
    curl \
    vim \
    # 图像处理库
    libopencv-dev \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    # 其他工具
    htop \
    tmux \
    && rm -rf /var/lib/apt/lists/*

# 升级pip
RUN python3 -m pip install --upgrade pip setuptools wheel

# 复制项目文件
COPY requirements.txt /workspace/
COPY code/04-deployment/huawei/requirements-ascend.txt /workspace/

# 安装基础依赖（排除PyTorch，使用镜像自带的）
RUN pip install --no-cache-dir \
    transformers>=4.35.0 \
    pillow==10.1.0 \
    opencv-python==4.8.1.78 \
    numpy==1.24.3 \
    pandas==2.1.3 \
    scikit-learn==1.3.2 \
    albumentations==1.3.1 \
    peft==0.6.2 \
    accelerate==0.25.0 \
    onnx==1.15.0 \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    pydantic==2.5.0 \
    python-multipart==0.0.6 \
    pyyaml==6.0.1 \
    python-dotenv==1.0.0 \
    loguru==0.7.2 \
    matplotlib==3.8.2 \
    seaborn==0.13.0 \
    tqdm==4.66.1 \
    requests==2.31.0 \
    aiohttp==3.9.1 \
    huggingface-hub==0.19.4 \
    datasets==2.15.0 \
    fire==0.5.0

# 安装昇腾特定依赖
# 注意：torch-npu 需要从华为官方源或基础镜像中获取，不能使用PyPI版本
# 基础镜像 ascend-pytorch:23.0.RC3 已包含 torch 和 torch_npu
RUN pip install --no-cache-dir \
    onnxruntime==1.16.3
# apex 需要从源码安装或使用预编译包
# RUN pip install --no-cache-dir apex  # 如需使用请从源码安装

# 安装CLIP（从源码安装）
RUN pip install --no-cache-dir git+https://github.com/openai/CLIP.git

# 复制项目代码
COPY . /workspace/

# 设置Python路径
ENV PYTHONPATH=/workspace:$PYTHONPATH

# 创建必要的目录
RUN mkdir -p /workspace/logs \
    /workspace/outputs \
    /workspace/models \
    /workspace/data \
    /workspace/checkpoints

# 安装项目
RUN pip install -e .

# 暴露端口
EXPOSE 8000 8888

# 健康检查（检查NPU是否可用）
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import torch; import torch_npu; assert torch.npu.is_available()" || exit 1

# 默认启动命令
CMD ["/bin/bash"]

# 使用说明：
# 构建镜像：
#   docker build -f docker/Dockerfile.huawei -t large-model-tutorial:ascend .
#
# 运行容器（需要映射NPU设备）：
#   docker run --device=/dev/davinci0 \
#     --device=/dev/davinci_manager \
#     --device=/dev/devmm_svm \
#     --device=/dev/hisi_hdc \
#     -v /usr/local/Ascend/driver:/usr/local/Ascend/driver \
#     -v $(pwd):/workspace \
#     -it --rm \
#     large-model-tutorial:ascend
#
# 运行API服务：
#   docker run --device=/dev/davinci0 \
#     --device=/dev/davinci_manager \
#     --device=/dev/devmm_svm \
#     --device=/dev/hisi_hdc \
#     -v /usr/local/Ascend/driver:/usr/local/Ascend/driver \
#     -v $(pwd):/workspace \
#     -p 8000:8000 \
#     -d \
#     --name vlm-ascend \
#     large-model-tutorial:ascend \
#     python code/04-deployment/huawei/acl_inference.py
#
# 注意事项：
# 1. 需要在昇腾服务器上构建和运行
# 2. 确保主机已安装CANN驱动和工具包
# 3. 根据实际NPU设备编号修改 --device 参数

