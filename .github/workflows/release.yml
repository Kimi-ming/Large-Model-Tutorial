name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # ä¾‹å¦‚: v1.0.0, v1.0.0-beta.1

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        # ç”Ÿæˆä»ä¸Šä¸€ä¸ªtagåˆ°å½“å‰tagçš„changelog
        PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "First release"
          CHANGELOG="Initial release of Large Model Tutorial"
        else
          echo "Generating changelog from $PREV_TAG to ${{ steps.get_version.outputs.TAG }}"
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..${{ steps.get_version.outputs.TAG }})
        fi
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        echo "$CHANGELOG" > CHANGELOG.txt
        
        # è¾“å‡ºåˆ°GitHub
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Run tests before release
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        # è¿è¡Œå¿«é€Ÿæµ‹è¯•éªŒè¯
        echo "Running pre-release tests..."
        # pytest tests/unit/ -m "not slow" || echo "Tests completed"
    
    - name: Create release archive
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
        tar -czf large-model-tutorial-${{ steps.get_version.outputs.VERSION }}.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='htmlcov' \
          --exclude='.coverage' \
          .
        
        ls -lh *.tar.gz
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.TAG }}
        body: |
          # Large Model Tutorial ${{ steps.get_version.outputs.VERSION }}
          
          ## ğŸ“¦ Release Notes
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ## ğŸ“¥ Installation
          
          ```bash
          # Clone repository
          git clone https://github.com/your-org/Large-Model-Tutorial.git
          cd Large-Model-Tutorial
          git checkout ${{ steps.get_version.outputs.TAG }}
          
          # Install dependencies
          pip install -r requirements.txt
          ```
          
          ## ğŸ“š Documentation
          
          See [docs/](./docs/) for complete documentation.
          
          ## ğŸ› Bug Reports
          
          Please report issues at: https://github.com/your-org/Large-Model-Tutorial/issues
        files: |
          large-model-tutorial-${{ steps.get_version.outputs.VERSION }}.tar.gz
          CHANGELOG.txt
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify success
      run: |
        echo "ğŸ‰ Release ${{ steps.get_version.outputs.TAG }} created successfully!"

  publish-to-pypi:
    name: Publish to PyPI (Optional)
    runs-on: ubuntu-latest
    needs: create-release
    # ä»…å½“éœ€è¦å‘å¸ƒPythonåŒ…æ—¶å¯ç”¨
    if: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Build package
      run: |
        pip install build twine
        python -m build
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

