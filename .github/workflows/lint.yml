name: Code Quality

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
    
    - name: Run Flake8
      run: |
        # 检查代码风格（忽略行长度和一些规则）
        flake8 code/ tests/ \
          --count \
          --select=E9,F63,F7,F82 \
          --show-source \
          --statistics \
          --exclude=__pycache__,*.pyc,examples/
    
    - name: Check code formatting with Black
      run: |
        # 检查代码格式（不自动修复）
        black --check --diff code/ tests/ || echo "⚠️ Code formatting issues found (non-blocking)"
    
    - name: Check import sorting with isort
      run: |
        # 检查import排序
        isort --check-only --diff code/ tests/ || echo "⚠️ Import sorting issues found (non-blocking)"
    
    - name: Type checking with MyPy
      run: |
        # 类型检查（宽松模式）
        mypy code/ --ignore-missing-imports --no-strict-optional || echo "⚠️ Type checking issues found (non-blocking)"
      continue-on-error: true
    
    - name: Check for security issues
      run: |
        pip install bandit
        # 安全检查
        bandit -r code/ -ll || echo "⚠️ Security issues found (non-blocking)"
      continue-on-error: true
    
    - name: Lint summary
      run: |
        echo "✅ Code quality checks completed!"

